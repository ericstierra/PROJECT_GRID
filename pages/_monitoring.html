<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Atimonan — Situation Monitoring Dashboard</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Leaflet + MarkerCluster + Heatmap -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Leaflet scripts (loaded at bottom for performance) -->
  <link rel="stylesheet" href="../css/monitoring.css">
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="d-flex align-items-center mb-3">
      <div class="me-2">
        <img src="../assets/images/pgrid_logo.png" alt="Logo" style="width:44px;height:44px;">
      </div>
      <div>
        <div class="brand">Project GRID</div>
        <div class="muted">Geolocation Ready Incidents Database</div>
      </div>
    </div>

    <div class="panel mb-3">
      <h5>Filters</h5>
      <div class="mb-2">
        <label class="form-label small muted">Incident Type</label>
        <select id="filterType" class="form-select form-select-sm">
          <option value="all">All</option>
        </select>
      </div>

      <div class="mb-2">
        <label class="form-label small muted">Barangay</label>
        <select id="filterBarangay" class="form-select form-select-sm">
          <option value="all">All</option>
        </select>
      </div>

      <div class="d-flex gap-2 mt-2">
        <button id="btnApplyFilters" class="btn btn-sm btn-primary w-100">Apply</button>
        <button id="btnClearFilters" class="btn btn-sm btn-outline-light w-100">Clear</button>
      </div>
    </div>

    <div class="panel">
      <h5>Latest Incidents</h5>
      <div id="incidentList" class="scroll-y mt-2">
        <!-- incident items injected here -->
      </div>
    </div>

    <div class="panel mt-3">
      <div class="muted">Map Center</div>
      <div class="kpi" id="mapCenterLabel">Atimonan, Quezon</div>
      <div class="muted">Last refresh: <span id="lastRefresh">—</span></div>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main-content">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="d-flex align-items-center gap-3">
        <button id="btnToggleSidebar" class="btn btn-sm btn-dark d-none d-lg-inline"><i class="bi bi-list"></i></button>
        <div>
          <div class="brand">MDRRMO - Situation Monitoring View</div>
          <div class="muted">Atimonan, Quezon</div>
        </div>
      </div>

      <div class="d-flex align-items-center gap-3">
        <div class="text-end me-2">
          <div class="muted small">Local Time</div>
          <div id="localTime" class="kpi">--:--</div>
        </div>
        <div class="d-flex align-items-center">
          <button id="btnRefresh" class="btn btn-sm btn-outline-light me-2"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
          <div class="text-muted small">User: MDRRMO</div>
        </div>
      </div>
    </div>

    <!-- PAGE CONTENT -->
    <div class="page-container">

      <!-- MAP COLUMN (center, fluid) -->
      <div style="flex:1; position:relative;">
        <div id="map"></div>

        <!-- map floating controls -->
        <div class="map-controls">
          <button id="zoomIn" title="Zoom In" class="btn"><i class="bi bi-zoom-in"></i></button>
          <button id="zoomOut" title="Zoom Out" class="btn"><i class="bi bi-zoom-out"></i></button>
          <button id="btnToggleBase" title="Toggle Base Map" class="btn"><i class="bi bi-map"></i></button>
          <button id="btnClusterToggle" title="Toggle Clusters" class="btn"><i class="bi bi-geo"></i></button>
          <button id="btnHeatToggle" title="Toggle Heatmap" class="btn"><i class="bi bi-fire"></i></button>
        </div>
      </div>

      <!-- RIGHT COLUMN (charts + legend) -->
      <div class="right-col">
        <div class="panel mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="card-title">Incidents by Type</div>
            <div class="muted small">Last 30 days</div>
          </div>
          <div class="chart-container chart-lg">
            <canvas id="typeChart"></canvas>
          </div>
        </div>

        <div class="panel mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="card-title">Incidents per Barangay</div>
            <div class="muted small">Aggregated</div>
          </div>
          <div class="chart-container chart-sm">
            <canvas id="barangayChart"></canvas>
          </div>
        </div>

        <div class="panel">
          <div class="card-title">Legend</div>
          <div class="legend mt-2 small" id="dynamicLegend">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Leaflet + plugins -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { incidentsData } from '../data/incidents_data.js';

    // -------------------------
    // Constants & dummy data
    // -------------------------
    // Map center: Atimonan, Quezon (municipal center ~ 14.003589, 121.919861)
    const ATIMONAN_CENTER = [14.003589, 121.919861];

    // Map incidentsData to the format expected by this dashboard
    const incidents = incidentsData.map(i => ({
      id: i.ir_id,
      title: `${i.nature_of_incident} — ${i.barangay}`,
      type: i.nature_of_incident,
      barangay: i.barangay,
      coords: [i.latitude, i.longitude],
      datetime: `${i.date} ${i.time}`,
      details: i.details,
      photo: i.photo
    }));

    // -------------------------
    // Color Mappings
    // -------------------------
    const typeColors = {
      'Fire': '#dc3545',
      'Road Crash': '#0d6efd',
      'Maritime': '#198754',
      'Flood': '#0dcaf0',
      'Landslide': '#8B4513', // Brown
      'Medical Emergency': '#ffc107',
      'Other': '#6c757d'
    };

    // Helper to get RGBA for backgrounds
    function getRgba(hex, alpha){
        const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
        return `rgba(${r},${g},${b},${alpha})`;
    }

    // -------------------------
    // UI helpers
    // -------------------------
    function $(q){ return document.querySelector(q); }
    function $all(q){ return Array.from(document.querySelectorAll(q)); }

    // Update local time display
    function updateLocalTime(){
      const el = $('#localTime');
      const now = new Date();
      el.textContent = now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
      $('#lastRefresh').textContent = now.toLocaleString();
    }
    setInterval(updateLocalTime,1000);
    updateLocalTime();

    // -------------------------
    // Filters Logic
    // -------------------------
    const filterTypeEl = $('#filterType');
    const filterBarangayEl = $('#filterBarangay');

    function populateFilters() {
        // Get unique values
        const types = [...new Set(incidents.map(i => i.type))].sort();
        const barangays = [...new Set(incidents.map(i => i.barangay))].sort();

        // Reset
        filterTypeEl.innerHTML = '<option value="all">All</option>';
        filterBarangayEl.innerHTML = '<option value="all">All</option>';

        // Fill
        types.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t;
            filterTypeEl.appendChild(opt);
        });
        barangays.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.textContent = b;
            filterBarangayEl.appendChild(opt);
        });
    }
    populateFilters();

    $('#btnApplyFilters').addEventListener('click', () => {
        const typeVal = filterTypeEl.value;
        const brgyVal = filterBarangayEl.value;

        const filtered = incidents.filter(i => {
            const matchType = (typeVal === 'all') || (i.type === typeVal);
            const matchBrgy = (brgyVal === 'all') || (i.barangay === brgyVal);
            return matchType && matchBrgy;
        });

        // Update UI
        drawMarkers(filtered);
        renderIncidentList(filtered);
        enableChartAnimations();
        updateCharts(filtered);
    });

    $('#btnClearFilters').addEventListener('click', () => {
        filterTypeEl.value = 'all';
        filterBarangayEl.value = 'all';
        // Reset to full list
        drawMarkers(incidents);
        renderIncidentList(incidents);
        enableChartAnimations();
        updateCharts(incidents);
    });

    // -------------------------
    // Map init
    // -------------------------
    const map = L.map('map', { zoomControl:false }).setView(ATIMONAN_CENTER, 13);

    // Basemaps
    const darkOSM = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png', {
      attribution: '© OpenStreetMap contributors | CARTO',
      maxZoom: 19
    });

    const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      attribution: '© Google',
      maxZoom: 20
    });

    // Start with Satellite
    googleSat.addTo(map);
    let currentBase = 'satellite';

    // Add zoom control top-right
    L.control.zoom({ position:'topright' }).addTo(map);

    // Marker cluster group
    const clusterGroup = L.markerClusterGroup();
    let heatLayer = null; // for heatmap
    let heatEnabled = false;

    // function to get colored marker icon by type
    function getIconByType(type){
      let color = 'blue';
      if (type === 'Fire') color = 'red';
      else if (type === 'Maritime') color = 'green';
      else if (type === 'Landslide') color = 'orange'; // Orange is closest to brown in this icon set
      else if (type === 'Flood') color = 'violet';
      else if (type === 'Medical Emergency') color = 'gold';

      return L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
      });
    }

    // Add markers to map (also used to refresh)
    let markers = []; // store L.marker objects
    function drawMarkers(list){
      // clear existing
      markers.forEach(m=> map.removeLayer(m));
      clusterGroup.clearLayers();
      markers = [];

      // create heat points array
      const heatPoints = [];

      list.forEach(item=>{
        const imgPreview = item.photo ? `<div style="margin-top:6px;text-align:center"><img src="${item.photo}" style="max-width:100%;max-height:100px;border-radius:4px;object-fit:cover;"></div>` : '';
        const marker = L.marker(item.coords, { icon: getIconByType(item.type) })
          .bindPopup(`<strong>${item.title}</strong><br/><small class="muted">${item.datetime}</small>${imgPreview}<div style="margin-top:6px">${item.details}</div><div class="muted" style="margin-top:6px">${item.id} — ${item.barangay}</div>`);
        markers.push(marker);
        clusterGroup.addLayer(marker);
        heatPoints.push([...item.coords, 0.6]); // [lat,lng,intensity]
      });

      map.addLayer(clusterGroup);

      // heatmap
      if (heatLayer){
        map.removeLayer(heatLayer);
        heatLayer = null;
      }
      heatLayer = L.heatLayer(heatPoints, {radius: 30, blur: 25, maxZoom: 17});
      if (heatEnabled) heatLayer.addTo(map);
    }

    // Initial draw
    drawMarkers(incidents);

    // -------------------------
    // Populate incident list (left)
    // -------------------------
    const incidentListEl = $('#incidentList');
    function renderIncidentList(list){
      incidentListEl.innerHTML = '';
      const sorted = list.slice().sort((a,b)=> new Date(b.datetime) - new Date(a.datetime));

      sorted.forEach(it=>{
        const borderColor = typeColors[it.type] || '#6c757d';
        const bgColor = getRgba(borderColor, 0.15);

        const div = document.createElement('div');
        div.className = 'incident-item';
        div.style.borderLeft = `4px solid ${borderColor}`;
        div.style.background = bgColor;

        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>${it.title}</strong><br/>
              <small class="muted">${it.barangay} • ${it.datetime}</small>
            </div>
            <div class="text-end">
              <div class="muted small">${it.type}</div>
              <div style="margin-top:8px">
                <button data-id="${it.id}" class="btn btn-sm btn-outline-light btn-view">View</button>
              </div>
            </div>
          </div>
          <div class="mt-2 muted small">${it.details}</div>
        `;
        incidentListEl.appendChild(div);
      });

      // attach view handlers
      $all('.btn-view').forEach(b=>{
        b.addEventListener('click', (e)=>{
          const id = e.currentTarget.getAttribute('data-id');
          const item = incidents.find(x=>x.id===id);
          if (item){
            map.setView(item.coords, 15, {animate:true});
            // open popup (find the marker)
            const mm = markers.find(m => m.getLatLng().lat.toFixed(5) == item.coords[0].toFixed(5) && m.getLatLng().lng.toFixed(5) == item.coords[1].toFixed(5));
            if (mm) mm.openPopup();
          }
        });
      });
    }
    renderIncidentList(incidents);

    // -------------------------
    // Charts
    // -------------------------
    // Create charts with initial animations disabled to avoid the "slide/fade out" effect
    const ctxType = document.getElementById('typeChart').getContext('2d');
    const typeCounts = incidents.reduce((acc,i)=> (acc[i.type]=(acc[i.type]||0)+1,acc), {});
    const typeChart = new Chart(ctxType, {
      type:'doughnut',
      data:{
        labels: [],
        datasets:[{ data:[], backgroundColor:[] }]
      },
      options:{
        plugins:{ legend:{ display:true, labels:{ color:'#e6eef2' } } },
        maintainAspectRatio:false,
        animation: false  // disable initial animation
      }
    });

    // Barangay bar chart (initial animation disabled)
    const ctxBarangay = document.getElementById('barangayChart').getContext('2d');
    const barangayCounts = incidents.reduce((acc,i)=> (acc[i.barangay]=(acc[i.barangay]||0)+1,acc), {});
    const barangayChart = new Chart(ctxBarangay, {
      type:'bar',
      data:{
        labels:Object.keys(barangayCounts),
        datasets:[{ data:Object.values(barangayCounts), backgroundColor:'#d63384', maxBarThickness:20 }]
      },
      options:{
        plugins:{ legend:{ display:false } },
        maintainAspectRatio:false,
        scales:{ x:{ ticks:{ color:'#cbd5da' } }, y:{ display:false } },
        animation: false // disable initial animation
      }
    });

    // Function to update charts
    function updateCharts(list){
        const tCounts = list.reduce((acc,i)=> (acc[i.type]=(acc[i.type]||0)+1,acc), {});
        typeChart.data.labels = Object.keys(tCounts);
        typeChart.data.datasets[0].data = Object.values(tCounts);
        typeChart.data.datasets[0].backgroundColor = Object.keys(tCounts).map(t => typeColors[t] || '#6c757d');
        typeChart.update();

        const bCounts = list.reduce((acc,i)=> (acc[i.barangay]=(acc[i.barangay]||0)+1,acc), {});
        barangayChart.data.labels = Object.keys(bCounts);
        barangayChart.data.datasets[0].data = Object.values(bCounts);
        barangayChart.update();
    }

    // -------------------------
    // Render Dynamic Legend
    // -------------------------
    const legendEl = document.getElementById('dynamicLegend');
    Object.keys(typeColors).forEach(type => {
        const div = document.createElement('div');
        div.className = 'mt-2';
        div.innerHTML = `<span class="dot" style="background:${typeColors[type]}"></span>${type}`;
        legendEl.appendChild(div);
    });

    // -------------------------
    // Ensure charts render reliably
    // -------------------------
    function resizeCharts(){
      try{
        // Chart.js v4 exposes resize() on chart instances
        typeChart.resize();
        barangayChart.resize();
        typeChart.update();
        barangayChart.update();
      }catch(e){
        // fallback: call update
        try{ typeChart.update(); barangayChart.update(); }catch(_){}
      }
    }

    // ResizeObserver: watch the right column (charts container) for size changes
    const rightCol = document.querySelector('.right-col');
    if (window.ResizeObserver && rightCol){
      const ro = new ResizeObserver(()=> resizeCharts());
      ro.observe(rightCol);
    }

    // Also call resize on window load and after a short delay (fonts/layout)
    window.addEventListener('load', ()=> {
      // Enable animations for subsequent updates after initial (no-animation) render
      try{
        typeChart.options.animation = { duration: 350, easing: 'easeOutQuart' };
        barangayChart.options.animation = { duration: 350, easing: 'easeOutQuart' };
      }catch(e){}
      // Do a quick no-animation update to stabilize pixel sizes, then a normal update
      try{ typeChart.update(0); barangayChart.update(0); }catch(_){}
      resizeCharts();
      setTimeout(resizeCharts, 250);
      setTimeout(resizeCharts, 600);
    });

    // If sidebar toggle exists, ensure charts resize after toggling
    const btnToggleSidebar = document.getElementById('btnToggleSidebar');
    if (btnToggleSidebar){
      btnToggleSidebar.addEventListener('click', ()=> {
        // allow CSS transition to finish before resizing
        setTimeout(resizeCharts, 260);
      });
    }

    // If map invalidation or other interactions occur, you can also call resizeCharts()
    // Example: when switching base layers or clusters which may affect layout
    document.getElementById('btnToggleBase').addEventListener('click', ()=> {
      if (currentBase === 'dark'){
        map.removeLayer(darkOSM);
        googleSat.addTo(map);
        currentBase = 'satellite';
      } else {
        map.removeLayer(googleSat);
        darkOSM.addTo(map);
        currentBase = 'dark';
      }
      setTimeout(resizeCharts, 200);
    });
    document.getElementById('btnClusterToggle').addEventListener('click', ()=> setTimeout(resizeCharts, 200));
    document.getElementById('btnHeatToggle').addEventListener('click', ()=> setTimeout(resizeCharts, 200));

    // Also ensure updateCharts uses enabled animations (it may be called later)
    function enableChartAnimations(){
      try{
        typeChart.options.animation = { duration: 350, easing: 'easeOutQuart' };
        barangayChart.options.animation = { duration: 350, easing: 'easeOutQuart' };
      }catch(e){}
    }

    // Refresh button (simulates refetch)
    $('#btnRefresh').addEventListener('click', ()=>{
      // In real app: fetch('/api/incidents').then(...)
      updateLocalTime();
      drawMarkers(incidents);
      renderIncidentList(incidents);
      enableChartAnimations();
      updateCharts(incidents);
    });

    // Map double-click to add a sample marker (dev helper)
    map.on('dblclick', (ev)=>{
      const latlng = ev.latlng;
      const newItem = { id:`IR-NEW-${Date.now()}`, title:'Manual Pin', type:'Road Crash', barangay:'Manual', coords:[latlng.lat, latlng.lng], datetime: new Date().toISOString().slice(0,16).replace('T',' '), details:'User created pin' };
      incidents.unshift(newItem);
      drawMarkers(incidents);
      renderIncidentList(incidents);
      enableChartAnimations();
      updateCharts(incidents);
    });

    // On load: set lastRefresh label
    $('#lastRefresh').textContent = new Date().toLocaleString();

    // Focus map to municipal center on start
    map.setView(ATIMONAN_CENTER, 13);

    // keyboard shortcut: press F to focus map
    document.addEventListener('keydown', (e)=>{
      if (e.key.toLowerCase() === 'f') map.invalidateSize();
    });
    
  </script>
</body>
</html>
