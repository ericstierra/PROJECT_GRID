<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Atimonan — Situation Monitoring Dashboard</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Leaflet + MarkerCluster + Heatmap -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Leaflet scripts (loaded at bottom for performance) -->
  <style>
    /* ---------- Basic Admin-like Layout ---------- */
    :root{
      --bg:#0b0d10;
      --panel:#121416;
      --muted:#9aa0a6;
      --accent:#0d6efd;
      --card-border:#222428;
    }

    html,body { height:100%; background:var(--bg); color:#e9eef2; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }

    /* Sidebar */
    .sidebar {
      width:260px;
      background: linear-gradient(180deg,#0f1113 0%, #0a0b0c 100%);
      border-right:1px solid var(--card-border);
      min-height:100vh;
      padding:12px;
      position:fixed;
      left:0; top:0; bottom:0;
      overflow:auto;
    }
    .main-content {
      margin-left:260px;
    }

    /* Header */
    .topbar {
      height:64px;
      background: linear-gradient(90deg,#0c0d10,#0b0c0e);
      border-bottom:1px solid var(--card-border);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 18px;
      position:sticky; top:0; z-index:1050;
    }
    .brand { font-weight:600; color:#fff; letter-spacing:.2px; }

    /* Page container */
    .page-container {
      display:flex;
      gap:18px;
      padding:18px;
      align-items:flex-start;
    }

    /* Left (filters + incidents) */
    .panel {
      background:linear-gradient(180deg,#111315,#0f1113);
      border:1px solid var(--card-border);
      border-radius:10px;
      padding:12px;
    }
    .panel h5 { color:#fff; margin-bottom:8px; }
    .scroll-y { max-height:calc(100vh - 200px); overflow:auto; padding-right:6px; }

    /* Map column */
    #map {
      width:100%;
      height:calc(100vh - 140px);
      border-radius:10px;
      border:1px solid var(--card-border);
      overflow:hidden;
    }
    .map-controls {
      position:absolute; z-index:1200; left:16px; top:86px;
      display:flex; flex-direction:column; gap:8px;
    }

    .map-controls .btn {
      background:rgba(255,255,255,0.06);
      color:#fff; border:1px solid rgba(255,255,255,0.04);
      width:40px; height:40px; display:flex; align-items:center; justify-content:center;
      border-radius:8px;
    }

    /* Right column */
    .right-col { width:320px; }

    /* Incident item */
    .incident-item {
      background:#141618; border:1px solid #2a2c2f; padding:10px; border-radius:8px; margin-bottom:10px;
    }
    .incident-item small { color:var(--muted); }

    /* legend icons */
    .legend .dot { width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:8px; vertical-align:middle; }

    /* responsive */
    @media (max-width: 991px){
      .sidebar { position:relative; width:100%; min-height:auto; display:flex; gap:10px; overflow:hidden; }
      .main-content { margin-left:0; }
      .page-container { flex-direction:column; padding:12px; }
      .right-col{ width:100%; }
      #map { height:400px; }
    }

    /* small helpers */
    .muted { color:var(--muted); font-size:13px; }
    .kpi { font-size:20px; font-weight:700; }
    .card-title { font-size:14px; color:#dfe7eb; margin-bottom:6px; }

    /* Ensure canvas layout is stable and visible during initial render */
    .panel canvas { display: block; width: 100% !important; height: auto !important; }
    .right-col { position: relative; } /* ensure ResizeObserver sees stable box */

    /* Chart container: fixed height, canvas fills it absolutely to avoid layout jumps */
    .chart-container { position: relative; width: 100%; overflow: visible; }
    .chart-container.chart-lg { height: 150px; }
    .chart-container.chart-sm { height: 120px; }
    .chart-container canvas { position: absolute !important; top: 0; left: 0; width: 100% !important; height: 100% !important; }

    /* Prevent CSS/JS-driven transforms/animations from shifting canvases */
    .panel canvas, .chart-container canvas { transition: none !important; animation: none !important; transform: none !important; }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="d-flex align-items-center mb-3">
      <div class="me-2">
        <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(180deg,#0d6efd,#0a58ca);display:flex;align-items:center;justify-content:center;font-weight:700;">G</div>
      </div>
      <div>
        <div class="brand">Project GRID</div>
        <div class="muted">Atimonan Incident Monitoring</div>
      </div>
    </div>

    <div class="panel mb-3">
      <h5>Filters</h5>
      <div class="mb-2">
        <label class="form-label small muted">Incident Type</label>
        <select id="filterType" class="form-select form-select-sm">
          <option value="all">All</option>
          <option value="Road Crash">Road Crash</option>
          <option value="Fire">Fire</option>
          <option value="Maritime">Maritime</option>
        </select>
      </div>

      <div class="mb-2">
        <label class="form-label small muted">Barangay</label>
        <select id="filterBarangay" class="form-select form-select-sm">
          <option value="all">All</option>
          <option>Tagbakin</option>
          <option>Balubad</option>
          <option>San Andres</option>
          <option>Poblacion</option>
          <option>Villa Ilaya</option>
          <option>Caridad Ibaba</option>
        </select>
      </div>

      <div class="d-flex gap-2 mt-2">
        <button id="btnApplyFilters" class="btn btn-sm btn-primary w-100">Apply</button>
        <button id="btnClearFilters" class="btn btn-sm btn-outline-light w-100">Clear</button>
      </div>
    </div>

    <div class="panel">
      <h5>Latest Incidents</h5>
      <div id="incidentList" class="scroll-y mt-2">
        <!-- incident items injected here -->
      </div>
    </div>

    <div class="panel mt-3">
      <div class="muted">Map Center</div>
      <div class="kpi" id="mapCenterLabel">Atimonan, Quezon</div>
      <div class="muted">Last refresh: <span id="lastRefresh">—</span></div>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main-content">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="d-flex align-items-center gap-3">
        <button id="btnToggleSidebar" class="btn btn-sm btn-dark d-none d-lg-inline"><i class="bi bi-list"></i></button>
        <div>
          <div class="brand">Situation Monitoring View</div>
          <div class="muted">Atimonan, Quezon — Frontend Prototype</div>
        </div>
      </div>

      <div class="d-flex align-items-center gap-3">
        <div class="text-end me-2">
          <div class="muted small">Local Time</div>
          <div id="localTime" class="kpi">--:--</div>
        </div>
        <div class="d-flex align-items-center">
          <button id="btnRefresh" class="btn btn-sm btn-outline-light me-2"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
          <div class="text-muted small">User: MDRRMO</div>
        </div>
      </div>
    </div>

    <!-- PAGE CONTENT -->
    <div class="page-container">

      <!-- MAP COLUMN (center, fluid) -->
      <div style="flex:1; position:relative;">
        <div id="map"></div>

        <!-- map floating controls -->
        <div class="map-controls">
          <button id="zoomIn" title="Zoom In" class="btn"><i class="bi bi-zoom-in"></i></button>
          <button id="zoomOut" title="Zoom Out" class="btn"><i class="bi bi-zoom-out"></i></button>
          <button id="btnToggleBase" title="Toggle Base Map" class="btn"><i class="bi bi-map"></i></button>
          <button id="btnClusterToggle" title="Toggle Clusters" class="btn"><i class="bi bi-geo"></i></button>
          <button id="btnHeatToggle" title="Toggle Heatmap" class="btn"><i class="bi bi-fire"></i></button>
        </div>
      </div>

      <!-- RIGHT COLUMN (charts + legend) -->
      <div class="right-col">
        <div class="panel mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="card-title">Incidents by Type</div>
            <div class="muted small">Last 30 days</div>
          </div>
          <div class="chart-container chart-lg">
            <canvas id="typeChart"></canvas>
          </div>
        </div>

        <div class="panel mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="card-title">Incidents per Barangay</div>
            <div class="muted small">Aggregated</div>
          </div>
          <div class="chart-container chart-sm">
            <canvas id="barangayChart"></canvas>
          </div>
        </div>

        <div class="panel">
          <div class="card-title">Legend</div>
          <div class="legend mt-2 small">
            <div><span class="dot" style="background:#0d6efd"></span>Road Crash</div>
            <div class="mt-2"><span class="dot" style="background:#dc3545"></span>Fire</div>
            <div class="mt-2"><span class="dot" style="background:#20c997"></span>Maritime</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Leaflet + plugins -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  (function(){
    // -------------------------
    // Constants & dummy data
    // -------------------------
    // Map center: Atimonan, Quezon (municipal center ~ 14.003589, 121.919861)
    const ATIMONAN_CENTER = [14.003589, 121.919861];

    // Dummy incident dataset (id, title, type, barangay, coords, datetime, details)
    const incidents = [
      { id: 'IR-2025-001', title:'Road Crash — Barangay Zone 2', type:'Road Crash', barangay:'Poblacion', coords:[14.0021,121.9182], datetime:'2025-11-25 15:04', details:'Motorcycle vs tricycle — 2 injured' },
      { id: 'IR-2025-002', title:'Fire — Balubad', type:'Fire', barangay:'Balubad', coords:[14.0075,121.9218], datetime:'2025-11-21 17:38', details:'Structural fire — 2 houses affected' },
      { id: 'IR-2025-003', title:'Maritime — Dummy Port', type:'Maritime', barangay:'Caridad Ibaba', coords:[14.0014,121.9294], datetime:'2025-11-23 09:00', details:'Boat capsized — 3 victims' },
      { id: 'IR-2025-004', title:'Road Crash — Tagbakin', type:'Road Crash', barangay:'Tagbakin', coords:[13.9980,121.9150], datetime:'2025-11-22 08:12', details:'Multiple vehicles — minor injuries' },
      { id: 'IR-2025-005', title:'Road Crash — Villa Ilaya', type:'Road Crash', barangay:'Villa Ilaya', coords:[14.0062,121.9089], datetime:'2025-11-20 19:02', details:'Pickup rollover — 1 serious' },
      { id: 'IR-2025-006', title:'Fire — San Andres', type:'Fire', barangay:'San Andres', coords:[14.0105,121.9345], datetime:'2025-11-18 12:30', details:'Kitchen fire — contained' }
    ];

    // -------------------------
    // UI helpers
    // -------------------------
    function $(q){ return document.querySelector(q); }
    function $all(q){ return Array.from(document.querySelectorAll(q)); }

    // Update local time display
    function updateLocalTime(){
      const el = $('#localTime');
      const now = new Date();
      el.textContent = now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
      $('#lastRefresh').textContent = now.toLocaleString();
    }
    setInterval(updateLocalTime,1000);
    updateLocalTime();

    // -------------------------
    // Map init
    // -------------------------
    const map = L.map('map', { zoomControl:false }).setView(ATIMONAN_CENTER, 13);

    // Basemaps
    const darkOSM = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png', {
      attribution: '© OpenStreetMap contributors | CARTO',
      maxZoom: 19
    });

    const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      attribution: '© Google',
      maxZoom: 20
    });

    // Start with dark OSM
    darkOSM.addTo(map);
    let currentBase = 'dark';

    // Add zoom control top-right
    L.control.zoom({ position:'topright' }).addTo(map);

    // Marker cluster group
    const clusterGroup = L.markerClusterGroup();
    let heatLayer = null; // for heatmap
    let heatEnabled = false;

    // function to get colored marker icon by type
    function getIconByType(type){
      const color = type === 'Fire' ? 'red' : type === 'Maritime' ? 'green' : 'blue';
      return L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
      });
    }

    // Add markers to map (also used to refresh)
    let markers = []; // store L.marker objects
    function drawMarkers(list){
      // clear existing
      markers.forEach(m=> map.removeLayer(m));
      clusterGroup.clearLayers();
      markers = [];

      // create heat points array
      const heatPoints = [];

      list.forEach(item=>{
        const marker = L.marker(item.coords, { icon: getIconByType(item.type) })
          .bindPopup(`<strong>${item.title}</strong><br/><small class="muted">${item.datetime}</small><div style="margin-top:6px">${item.details}</div><div class="muted" style="margin-top:6px">${item.id} — ${item.barangay}</div>`);
        markers.push(marker);
        clusterGroup.addLayer(marker);
        heatPoints.push([...item.coords, 0.6]); // [lat,lng,intensity]
      });

      map.addLayer(clusterGroup);

      // heatmap
      if (heatLayer){
        map.removeLayer(heatLayer);
        heatLayer = null;
      }
      heatLayer = L.heatLayer(heatPoints, {radius: 30, blur: 25, maxZoom: 17});
      if (heatEnabled) heatLayer.addTo(map);
    }

    // Initial draw
    drawMarkers(incidents);

    // -------------------------
    // Populate incident list (left)
    // -------------------------
    const incidentListEl = $('#incidentList');
    function renderIncidentList(list){
      incidentListEl.innerHTML = '';
      const sorted = list.slice().sort((a,b)=> new Date(b.datetime) - new Date(a.datetime));
      sorted.forEach(it=>{
        const div = document.createElement('div');
        div.className = 'incident-item';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>${it.title}</strong><br/>
              <small class="muted">${it.barangay} • ${it.datetime}</small>
            </div>
            <div class="text-end">
              <div class="muted small">${it.type}</div>
              <div style="margin-top:8px">
                <button data-id="${it.id}" class="btn btn-sm btn-outline-light btn-view">View</button>
              </div>
            </div>
          </div>
          <div class="mt-2 muted small">${it.details}</div>
        `;
        incidentListEl.appendChild(div);
      });

      // attach view handlers
      $all('.btn-view').forEach(b=>{
        b.addEventListener('click', (e)=>{
          const id = e.currentTarget.getAttribute('data-id');
          const item = incidents.find(x=>x.id===id);
          if (item){
            map.setView(item.coords, 15, {animate:true});
            // open popup (find the marker)
            const mm = markers.find(m => m.getLatLng().lat.toFixed(5) == item.coords[0].toFixed(5) && m.getLatLng().lng.toFixed(5) == item.coords[1].toFixed(5));
            if (mm) mm.openPopup();
          }
        });
      });
    }
    renderIncidentList(incidents);

    // -------------------------
    // Charts
    // -------------------------
    // Create charts with initial animations disabled to avoid the "slide/fade out" effect
    const ctxType = document.getElementById('typeChart').getContext('2d');
    const typeCounts = incidents.reduce((acc,i)=> (acc[i.type]=(acc[i.type]||0)+1,acc), {});
    const typeChart = new Chart(ctxType, {
      type:'doughnut',
      data:{
        labels: Object.keys(typeCounts),
        datasets:[{ data:Object.values(typeCounts), backgroundColor:['#0d6efd','#dc3545','#20c997'] }]
      },
      options:{
        plugins:{ legend:{ display:true, labels:{ color:'#e6eef2' } } },
        maintainAspectRatio:false,
        animation: false  // disable initial animation
      }
    });

    // Barangay bar chart (initial animation disabled)
    const ctxBarangay = document.getElementById('barangayChart').getContext('2d');
    const barangayCounts = incidents.reduce((acc,i)=> (acc[i.barangay]=(acc[i.barangay]||0)+1,acc), {});
    const barangayChart = new Chart(ctxBarangay, {
      type:'bar',
      data:{
        labels:Object.keys(barangayCounts),
        datasets:[{ data:Object.values(barangayCounts), backgroundColor:'#d63384', maxBarThickness:20 }]
      },
      options:{
        plugins:{ legend:{ display:false } },
        maintainAspectRatio:false,
        scales:{ x:{ ticks:{ color:'#cbd5da' } }, y:{ display:false } },
        animation: false // disable initial animation
      }
    });

    // -------------------------
    // Ensure charts render reliably
    // -------------------------
    function resizeCharts(){
      try{
        // Chart.js v4 exposes resize() on chart instances
        typeChart.resize();
        barangayChart.resize();
        typeChart.update();
        barangayChart.update();
      }catch(e){
        // fallback: call update
        try{ typeChart.update(); barangayChart.update(); }catch(_){}
      }
    }

    // ResizeObserver: watch the right column (charts container) for size changes
    const rightCol = document.querySelector('.right-col');
    if (window.ResizeObserver && rightCol){
      const ro = new ResizeObserver(()=> resizeCharts());
      ro.observe(rightCol);
    }

    // Also call resize on window load and after a short delay (fonts/layout)
    window.addEventListener('load', ()=> {
      // Enable animations for subsequent updates after initial (no-animation) render
      try{
        typeChart.options.animation = { duration: 350, easing: 'easeOutQuart' };
        barangayChart.options.animation = { duration: 350, easing: 'easeOutQuart' };
      }catch(e){}
      // Do a quick no-animation update to stabilize pixel sizes, then a normal update
      try{ typeChart.update(0); barangayChart.update(0); }catch(_){}
      resizeCharts();
      setTimeout(resizeCharts, 250);
      setTimeout(resizeCharts, 600);
    });

    // If sidebar toggle exists, ensure charts resize after toggling
    const btnToggleSidebar = document.getElementById('btnToggleSidebar');
    if (btnToggleSidebar){
      btnToggleSidebar.addEventListener('click', ()=> {
        // allow CSS transition to finish before resizing
        setTimeout(resizeCharts, 260);
      });
    }

    // If map invalidation or other interactions occur, you can also call resizeCharts()
    // Example: when switching base layers or clusters which may affect layout
    document.getElementById('btnToggleBase').addEventListener('click', ()=> setTimeout(resizeCharts, 200));
    document.getElementById('btnClusterToggle').addEventListener('click', ()=> setTimeout(resizeCharts, 200));
    document.getElementById('btnHeatToggle').addEventListener('click', ()=> setTimeout(resizeCharts, 200));

    // Also ensure updateCharts uses enabled animations (it may be called later)
    function enableChartAnimations(){
      try{
        typeChart.options.animation = { duration: 350, easing: 'easeOutQuart' };
        barangayChart.options.animation = { duration: 350, easing: 'easeOutQuart' };
      }catch(e){}
    }

    // Refresh button (simulates refetch)
    $('#btnRefresh').addEventListener('click', ()=>{
      // In real app: fetch('/api/incidents').then(...)
      updateLocalTime();
      drawMarkers(incidents);
      renderIncidentList(incidents);
      enableChartAnimations();
      updateCharts(incidents);
    });

    // Map double-click to add a sample marker (dev helper)
    map.on('dblclick', (ev)=>{
      const latlng = ev.latlng;
      const newItem = { id:`IR-NEW-${Date.now()}`, title:'Manual Pin', type:'Road Crash', barangay:'Manual', coords:[latlng.lat, latlng.lng], datetime: new Date().toISOString().slice(0,16).replace('T',' '), details:'User created pin' };
      incidents.unshift(newItem);
      drawMarkers(incidents);
      renderIncidentList(incidents);
      enableChartAnimations();
      updateCharts(incidents);
    });

    // On load: set lastRefresh label
    $('#lastRefresh').textContent = new Date().toLocaleString();

    // Focus map to municipal center on start
    map.setView(ATIMONAN_CENTER, 13);

    // keyboard shortcut: press F to focus map
    document.addEventListener('keydown', (e)=>{
      if (e.key.toLowerCase() === 'f') map.invalidateSize();
    });

  })();
  </script>
</body>
</html>
