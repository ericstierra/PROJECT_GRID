<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project GRID</title>
    <link rel="shortcut icon" href="../assets/images/pgrid_logo.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sb_nav.css">
    <link rel="stylesheet" href="../css/user_management.css">
    <link rel="stylesheet" href="../css/admin-lte/adminlte.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>

    <div class="wrapper">
        <!-- Sidebar Placeholder -->
        <div id="sidebar-container"></div>

        <!-- Main Component -->
        <div class="main d-flex flex-column min-vh-100">
            <!-- Navbar Placeholder -->
            <div id="navbar-container"></div>

            <main class="content px-3 py-2 flex-grow-1">
                <!-- Content will be loaded here dynamica lly -->
            </main>
            <footer class="app-footer">
            <!--begin::To the end-->
            <div class="float-end d-none d-sm-inline">Developed by BSCS 4th Year Students - Group 11</div>
            <!--end::To the end-->
            <!--begin::Copyright-->
            <strong>
                Copyright &copy; 2025-2026&nbsp;
                <a href="https://adminlte.io" class="text-decoration-none">QECI</a>.
            </strong>
            All rights reserved.
            <!--end::Copyright-->
        </footer>
        </div>
    </div>
    <!--end::Footer-->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/utils/template.js"></script>
    <script src="../js/admin-lte/adminlte.min.js"></script>
    <script src="../js/admin-lte/adminlte.js"></script>

    <script type="module">
        import { user_data } from '../data/users_data.js';

        document.addEventListener('DOMContentLoaded', () => {
            let authUser = JSON.parse(localStorage.getItem('sessionUser'));

            // Sync session data with latest user_data to ensure updates (like photo) are applied
            if (authUser && authUser.user) {
                const freshUser = user_data.find(u => u.id === authUser.user.id);
                if (freshUser) {
                    authUser.user = freshUser;
                    localStorage.setItem('sessionUser', JSON.stringify(authUser));
                }
            }

            const timeout = localStorage.getItem('sessionTimeout');

            const logout = () => {
                localStorage.removeItem('sessionUser');
                localStorage.removeItem('sessionTimeout');
                Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: "Session has expired.",
                    footer: '<a href="#">Please login to continue using our application.</a>'
                });
                setTimeout(() => {
                    window.location.href = './login.html';
                }, 5000);
            }

            const isSessionValid = () => {
                if (!timeout) return false;
                if (Date.now() < Number(timeout)) {
                    return true;
                }
            }

            const checkSession = () => {
                if (!authUser.isRemember && !isSessionValid())
                    logout();
            }

            if (authUser && authUser.user) {
                checkSession();
            } else {
                window.location.href = './login.html';
            }

            // Wait for navbar to be injected
            const navbarContainer = document.getElementById('navbar-container');
            const observer = new MutationObserver((mutations, obs) => {
                const fullNames = document.querySelectorAll('.user-full-name');
                const userImages = document.querySelectorAll('.user-profile-img');
                const signoutBtn = document.querySelector('#sign-out');

                if (fullNames.length > 0 && authUser && authUser.user) {
                    fullNames.forEach(el => el.textContent = authUser.user.fullName);
                    
                    if (userImages.length > 0 && authUser.user.photo) {
                        userImages.forEach(img => {
                            img.src = authUser.user.photo;
                            img.onerror = () => {
                                img.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(authUser.user.fullName)}&background=random`;
                            };
                        });
                    }
                    
                    obs.disconnect();
                }

                if (signoutBtn) {
                    signoutBtn.onclick = logout;
                }
            });

            if (navbarContainer) {
                observer.observe(navbarContainer, { childList: true, subtree: true });
            }

            ['mousemove', 'keydown', 'click'].forEach(e => {
                document.addEventListener(e, () => {
                    checkSession();
                });
            });
        });
    </script>

</body>

</html>