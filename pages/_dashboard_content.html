<!-- Main content for Dashboard -->
<link rel="stylesheet" href="../css/dashboard.css">
<div class="row">
    <div class="col-sm-6">
        <h1 class="h3 mb-4 fade-header">Dashboard</h1>
    </div>
    <div class="col-sm-6">
        <ol class="breadcrumb float-sm-end">
            <li class="breadcrumb-item"><a href="#">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
        </ol>
    </div>
</div>

<!-- Small Boxes (Stat card) -->
<div class="row">
    <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box text-bg-primary">
            <div class="inner">
                <h3 id="totalIncidents">0</h3>
                <p>Total Incidents</p>
            </div>
            <div class="small-box-icon">
                <i class="bi bi-journal-album"></i>
            </div>
            <a href="#" class="small-box-footer link-light link-underline-opacity-0 link-underline-opacity-50-hover">More info <i class="bi bi-arrow-right-circle"></i></a>
        </div>
    </div>
    <!-- ./col -->
    <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box text-bg-success">
            <div class="inner">
                <h3 id="incidentsYear">0</h3>
                <p>Incidents This Year</p>
            </div>
            <div class="small-box-icon">
                <i class="bi bi-calendar-check"></i>
            </div>
            <a href="#" class="small-box-footer link-light link-underline-opacity-0 link-underline-opacity-50-hover">More info <i class="bi bi-arrow-right-circle"></i></a>
        </div>
    </div>
    <!-- ./col -->
    <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box text-bg-warning">
            <div class="inner">
                <h3 id="incidentsMonth">0</h3>
                <p>Incidents This Month</p>
            </div>
            <div class="small-box-icon">
                <i class="bi bi-calendar-month"></i>
            </div>
            <a href="#" class="small-box-footer link-dark link-underline-opacity-0 link-underline-opacity-50-hover">More info <i class="bi bi-arrow-right-circle"></i></a>
        </div>
    </div>
    <!-- ./col -->
    <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box text-bg-danger">
            <div class="inner">
                <h3 id="incidentsToday">0</h3>
                <p>Incidents Today</p>
            </div>
            <div class="small-box-icon">
                <i class="bi bi-clock-history"></i>
            </div>
            <a href="#" class="small-box-footer link-light link-underline-opacity-0 link-underline-opacity-50-hover">More info <i class="bi bi-arrow-right-circle"></i></a>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-6">
        <div class="card card-primary card-outline">
            <div class="card-header">
                <h3 class="card-title">Incidents by Type</h3>
            </div>
            <div class="card-body">
                <canvas id="incidentTypeChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card card-primary card-outline">
            <div class="card-header">
                <h3 class="card-title">Incidents by Barangay</h3>
            </div>
            <div class="card-body">
                <canvas id="incidentBarangayChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Load page-specific script -->
<script type="module">
    import { incidentsData } from '../data/incidents_data.js';

    // 1. Calculate KPI Counts
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();
    const currentDate = now.getDate();

    const total = incidentsData.length;
    const thisYear = incidentsData.filter(i => new Date(i.date).getFullYear() === currentYear).length;
    const thisMonth = incidentsData.filter(i => {
        const d = new Date(i.date);
        return d.getFullYear() === currentYear && d.getMonth() === currentMonth;
    }).length;
    const today = incidentsData.filter(i => {
        const d = new Date(i.date);
        return d.getFullYear() === currentYear && d.getMonth() === currentMonth && d.getDate() === currentDate;
    }).length;

    document.getElementById('totalIncidents').textContent = total;
    document.getElementById('incidentsYear').textContent = thisYear;
    document.getElementById('incidentsMonth').textContent = thisMonth;
    document.getElementById('incidentsToday').textContent = today;

    // 2. Prepare Chart Data
    const natureCounts = {};
    const barangayCounts = {};

    incidentsData.forEach(ir => {
        natureCounts[ir.nature_of_incident] = (natureCounts[ir.nature_of_incident] || 0) + 1;
        barangayCounts[ir.barangay] = (barangayCounts[ir.barangay] || 0) + 1;
    });

    // 3. Render Charts
    // Incident Type Chart (Doughnut)
    const ctxType = document.getElementById('incidentTypeChart').getContext('2d');
    new Chart(ctxType, {
        type: 'doughnut',
        data: {
            labels: Object.keys(natureCounts),
            datasets: [{
                data: Object.values(natureCounts),
                backgroundColor: ['#0d6efd', '#dc3545', '#ffc107', '#198754', '#0dcaf0', '#6c757d'],
            }]
        },
        options: {
            maintainAspectRatio: false,
        }
    });

    // Incident Barangay Chart (Bar)
    const ctxBarangay = document.getElementById('incidentBarangayChart').getContext('2d');
    new Chart(ctxBarangay, {
        type: 'bar',
        data: {
            labels: Object.keys(barangayCounts),
            datasets: [{
                label: 'Incidents',
                data: Object.values(barangayCounts),
                backgroundColor: '#0d6efd'
            }]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>